let workerCode='let QWorker=class{constructor(){this.logging=!1;let e=new Map,r=new Map,t=!1,o=!1,i=this,n=!1,s=!1,a=!1,l=6e4,g=18e4,p=new Map,d=!1,f=Date.now(),h=0,u=function(){i.log("Worker "+t+" sending request to shut down");clearInterval(QOper8Worker.timer),postMessage({qoper8:{shutdown:!0}}),i.emit("shutdown_signal_sent")},c=function(e){(e=e||{}).qoper8||(e.qoper8={}),e.qoper8.finished=!0,postMessage(e),i.emit("finished",e),n=!1,s&&u()};this.getMessageCount=function(){return h},this.on=function(r,t){e.has(r)||e.set(r,t)},this.off=function(r){e.has(r)&&e.delete(r)},this.emit=function(r,t){if(e.has(r)){e.get(r).call(this,t)}},this.onMessage=function(e){let m;if(f=Date.now(),n=!0,e.qoper8&&e.qoper8.init&&void 0!==e.qoper8.id)return o?(m="QOper8 Worker "+t+" has already been initialised",i.emit("error",m),c({error:m,originalMessage:e})):(t=e.qoper8.id,a=e.qoper8.uuid,e.qoper8.workerInactivityCheckInterval&&(l=e.qoper8.workerInactivityCheckInterval),e.qoper8.workerInactivityLimit&&(g=e.qoper8.workerInactivityLimit),e.qoper8.handlersByMessageType&&(p=e.qoper8.handlersByMessageType),i.logging=e.qoper8.logging,d=setInterval(function(){let e=Date.now()-f;i.log("Worker "+t+" inactive for "+e),i.log("Inactivity limit: "+g),e>g&&(n?(i.log("Worker "+t+" flagged for termination"),s=!0):u())},l),i.log("new worker "+t+" started..."),i.emit("started",{id:t}),o=!0,c());if(!o)return m="QOper8 Worker "+t+" has not been initialised",i.emit("error",m),c({error:m,originalMessage:e});if(!e.qoper8||!e.qoper8.uuid)return m="Invalid message sent to QOper8 Worker "+t,i.emit("error",m),c({error:m,originalMessage:e});if(e.qoper8.uuid!==a)return m="Invalid UUID on message sent to QOper8 Worker "+t,i.emit("error",m),c({error:m,originalMessage:e});let y=JSON.parse(JSON.stringify(e));if(delete e.qoper8.uuid,delete y.qoper8,i.log("Message received by worker "+t+": "+JSON.stringify(y,null,2)),i.emit("received",{message:y}),"qoper8_terminate"!==e.type){if(!e.type&&!e.handlerUrl)return m="No type or handler specified in message sent to worker "+t,i.emit("error",m),c({error:m,originalMessage:y});if(!e.type||!p.has(e.type))return m="No handler for messages of type "+e.type,i.log(m),i.emit("error",m),c({error:m,originalMessage:y});if(!r.has(e.type)){let o=p.get(e.type);i.log("fetching "+o);try{importScripts(o);let n=self.handler;r.set(e.type,n),i.emit("handler_imported",{handlerUrl:o})}catch(e){return m="Unable to load Handler Url "+o,i.log(m),i.log(JSON.stringify(e,null,2)),i.emit("error",m),c({error:m,originalMessage:y,workerId:t})}}h++,r.get(e.type).call(i,e,c)}else u()}}log(e){this.logging&&console.log(Date.now()+": "+e)}},QOper8Worker=new QWorker;onmessage=async function(e){QOper8Worker.onMessage(e.data)};';class QOper8{constructor(e){(e=e||{}).workerInactivityCheckInterval&&(e.workerInactivityCheckInterval=1e3*e.workerInactivityCheckInterval),e.workerInactivityLimit&&(e.workerInactivityLimit=6e4*e.workerInactivityLimit),this.name="QOper8",this.build="2.5",this.buildDate="15 August 2022",this.logging=e.logging||!1;let r=+e.poolSize||1,t=e.maxPoolSize||32;r>t&&(r=t);e.disabled;let i=e.workerInactivityCheckInterval||6e4,o=e.workerInactivityLimit||12e5;this.handlersByMessageType=e.handlersByMessageType||new Map;let n=new Map,a="https:"===window.location.protocol?([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)):"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){let r=16*Math.random()|0;return("x"==e?r:3&r|8).toString(16)}),s=new Map,l=new Map,g=new Map,p=[],d=0,c=!1,u=0,h=this;function m(){if(h.log("try processing queue: length "+p.length),0===p.length)return void h.log("Queue empty");let e=function(){for(const[e,r]of s){if(r.id=e,l.get(+r.id))return r;h.log("worker "+e+" is not available")}return!1}();e?(h.log("worker "+e.id+" was available. Sending message to it"),function(e){if(0===p.length)return;let r=p.shift(),t=e.id;g.set(t,r.qoper8.callback),delete r.qoper8.callback,l.set(+t,!1),f(r,e),h.emit("sentToWorker",{message:r,workerId:t})}(e)):(h.log("no available workers"),s.size<r&&(h.log("starting new worker"),function(){let e,r=h.createUrl(workerCode);r?e=new Worker(r):(e={}).postMessage=function(e){};e.onmessage=function(r){let t=r.data,i=JSON.parse(JSON.stringify(t));if(delete i.qoper8,h.emit("replyReceived",{reply:i,workerId:e.id}),h.log("response received from Worker: "+e.id),h.log(JSON.stringify(i,null,2)),g.has(e.id)){let r=g.get(e.id);r&&r(t,e.id),g.delete(e.id)}t.qoper8&&(t.qoper8.finished?(l.set(+e.id,!0),h.emit("worker"+e.id+"Available"),c||m()):t.qoper8.shutdown&&(h.log("Master shutting down worker "+e.id),s.delete(e.id),h.emit("workerTerminated",e.id),h.emit("worker"+e.id+"Terminated"),e.terminate()))},e.id=d++,f({qoper8:{init:!0,id:e.id,handlersByMessageType:h.handlersByMessageType,workerInactivityCheckInterval:i,workerInactivityLimit:o,logging:h.logging}},e),s.set(e.id,e),h.emit("workerStarted",e.id)}()))}function f(e,r){e.qoper8||(e.qoper8={}),e.qoper8.uuid=a,r.postMessage(e)}function w(e){return new Promise(r=>{h.on("worker"+e+"Available",function(){h.off("worker"+e+"Available"),r()})})}function y(e){return new Promise(r=>{h.on("worker"+e+"Terminated",function(){h.off("worker"+e+"Terminated"),r()})})}this.log=function(e){!logging.disabled&&this.logging&&console.log(Date.now()+": "+e)},this.getMessageCount=function(){return u},this.on=function(e,r){n.has(e)||n.set(e,r)},this.off=function(e){n.has(e)&&n.delete(e)},this.emit=function(e,r){if(n.has(e)){n.get(e).call(h,r)}},this.getQueueLength=function(){return p.length},this.message=function(e,r){e.qoper8||(e.qoper8={}),e.qoper8.callback=r||!1,function(e){c?e.qoper8&&e.qoper8.callback&&e.qoper8.callback({error:"QOper8 has been stopped"}):(u++,p.push(e),h.emit("addedToQueue",e),m())}(e)},this.stop=async function(){c=!0;for(const[e,r]of s)if(l.get(+e)){h.log("Web Worker "+e+" is being stopped"),f({type:"qoper8_terminate"},r),await y(e),h.log("Worker Thread "+e+" has been stopped")}else{h.log("Waiting for Worker Thread "+e+" to become available"),await w(e),f({type:"qoper8_terminate"},r),await y(e),h.log("Worker Thread "+e+" has been stopped")}h.emit("stop"),h.log("No Worker Threads are running.  QOper8 is no longer handling messages")},this.start=function(){c=!1,h.log("QOper8 is started and will handle messages"),m()}}send(e){let r=this;return new Promise(t=>{r.message(e,function(e){t(e)})})}createUrl(e){let r,t;try{r=new Blob([e],{type:"application/javascript"})}catch(t){try{let t=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder);t.append(e),r=t.getBlob("application/javascript")}catch(e){return!1}}try{t=(window.URL||window.webkitURL).createObjectURL(r)}catch(e){t=!1}return t}}export{QOper8};