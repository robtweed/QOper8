let workerCode='let QWorker=class{constructor(){this.logging=!1;let e,r=new Map,t=new Map,o=!1,i=!1,n=this,s=!1,a=!1,g=!1,l=6e4,p=18e4,u=new Map,c=!1,d=Date.now(),y=0;"undefined"!=typeof Bun&&(e=require("path"));let f=function(){n.log("Worker "+o+" sending request to shut down");c&&clearInterval(c),postMessage({qoper8:{shutdown:!0}}),n.emit("shutdown_signal_sent")},m=function(e){(e=e||{}).qoper8||(e.qoper8={}),e.qoper8.finished=!0,postMessage(e),n.emit("finished",e),s=!1,a&&f()};this.getMessageCount=function(){return y},this.on=function(e,t){r.has(e)||r.set(e,t)},this.off=function(e){r.has(e)&&r.delete(e)},this.emit=function(e,t){if(r.has(e)){r.get(e).call(this,t)}},this.onMessage=async function(r){let h;if(d=Date.now(),s=!0,r.qoper8&&r.qoper8.init&&void 0!==r.qoper8.id){if(i)return h="QOper8 Worker "+o+" has already been initialised",n.emit("error",h),m({error:h,originalMessage:r});if("undefined"!=typeof Bun&&r.qoper8.onStartupModule){let t;try{let{onStartupModule:i}=await import(e.resolve(process.cwd(),r.qoper8.onStartupModule));t=i}catch(e){return h="Unable to load onStartup customisation module "+r.qoper8.onStartupModule,n.log(h),n.log(JSON.stringify(e,Object.getOwnPropertyNames(e))),n.emit("error",{error:h,caughtError:JSON.stringify(e,Object.getOwnPropertyNames(e))}),m({error:h,caughtError:JSON.stringify(e,Object.getOwnPropertyNames(e)),originalMessage:r,workerId:o})}try{t.call(n,r.qoper8.onStartupArguments)}catch(e){return h="Error running onStartup customisation module "+r.qoper8.onStartupModule,n.log(h),n.log(JSON.stringify(e,Object.getOwnPropertyNames(e))),n.emit("error",{error:h,caughtError:JSON.stringify(e,Object.getOwnPropertyNames(e))}),m({error:h,caughtError:JSON.stringify(e,Object.getOwnPropertyNames(e)),originalMessage:r,workerId:o})}}return o=r.qoper8.id,g=r.qoper8.uuid,r.qoper8.workerInactivityCheckInterval&&(l=r.qoper8.workerInactivityCheckInterval),r.qoper8.workerInactivityLimit&&(p=r.qoper8.workerInactivityLimit),r.qoper8.handlersByMessageType&&(u=r.qoper8.handlersByMessageType),n.logging=r.qoper8.logging,c=setInterval(function(){let e=Date.now()-d;n.log("Worker "+o+" inactive for "+e),n.log("Inactivity limit: "+p),e>p&&(s?(n.log("Worker "+o+" flagged for termination"),a=!0):f())},l),n.log("new worker "+o+" started..."),n.emit("started",{id:o}),i=!0,m()}if(!i)return h="QOper8 Worker "+o+" has not been initialised",n.emit("error",h),m({error:h,originalMessage:r});if(!r.qoper8||!r.qoper8.uuid)return h="Invalid message sent to QOper8 Worker "+o,n.emit("error",h),m({error:h,originalMessage:r});if(r.qoper8.uuid!==g)return h="Invalid UUID on message sent to QOper8 Worker "+o,n.emit("error",h),m({error:h,originalMessage:r});let O={...r};if(delete r.qoper8.uuid,delete O.qoper8,n.log("Message received by worker "+o+": "+JSON.stringify(O,null,2)),n.emit("received",{message:O}),"qoper8_terminate"!==r.type){if(!r.type&&!r.handlerUrl)return h="No type or handler specified in message sent to worker "+o,n.emit("error",h),m({error:h,originalMessage:O});if(!r.type||!u.has(r.type))return h="No handler for messages of type "+r.type,n.log(h),n.emit("error",h),m({error:h,originalMessage:O});{if(!t.has(r.type)){let i=u.get(r.type);i.module&&(i=i.module),n.log("fetching "+i);try{let s;if("undefined"!=typeof Bun){let{handler:r}=await import(e.resolve(process.cwd(),i));s=r}else importScripts(i),s=self.handler;t.set(r.type,s),n.emit("handler_imported",{handlerUrl:i})}catch(e){return h="Unable to load Handler Url "+i,n.log(h),n.log(JSON.stringify(e,Object.getOwnPropertyNames(e))),n.emit("error",{error:h,caughtError:JSON.stringify(e,Object.getOwnPropertyNames(e))}),m({error:h,caughtError:JSON.stringify(e,Object.getOwnPropertyNames(e)),originalMessage:O,workerId:o})}}y++;let i=t.get(r.type);try{let e={...n};e.id=o,i.call(e,r,m)}catch(e){return h="Error running Handler Method for type "+r.type,n.log(h),n.log(JSON.stringify(e,Object.getOwnPropertyNames(e))),n.emit("error",{error:h,caughtError:JSON.stringify(e,Object.getOwnPropertyNames(e))}),c&&clearInterval(c),m({error:h,caughtError:JSON.stringify(e,Object.getOwnPropertyNames(e)),shutdown:!0,originalMessage:O,workerId:o})}}}else f()}}log(e){this.logging&&console.log(Date.now()+": "+e)}},QOper8Worker=new QWorker;onmessage=async function(e){QOper8Worker.onMessage(e.data)};';class QOper8{constructor(e){(e=e||{}).workerInactivityCheckInterval&&(e.workerInactivityCheckInterval=1e3*e.workerInactivityCheckInterval),e.workerInactivityLimit&&(e.workerInactivityLimit=6e4*e.workerInactivityLimit),this.name="QOper8",this.build="3.1",this.buildDate="8 September 2023",this.logging=e.logging||!1;let r=+e.poolSize||1,t=e.maxPoolSize||32;r>t&&(r=t);let o=e.disabled||!1,n=e.workerInactivityCheckInterval||6e4,i=e.workerInactivityLimit||12e5;this.handlersByMessageType=e.handlersByMessageType||new Map;let a=e.handlerTimeout||!1,s=e.onStartup||{},l=s.module,g=s.arguments,p=new Map,d="undefined"!=typeof window&&"https:"===window.location.protocol?([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)):"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){let r=16*Math.random()|0;return("x"==e?r:3&r|8).toString(16)}),c=new Map,u=new Map,h=new Map,m=new Map,f=[],w=0,y=!1,k=0,O=this;function q(){if(O.log("try processing queue: length "+f.length),0===f.length)return void O.log("Queue empty");let e=function(){for(const[e,r]of c){if(r.id=e,u.get(+r.id))return r;O.log("worker "+e+" is not available")}return!1}();e?(O.log("worker "+e.id+" was available. Sending message to it"),function(e){if(0===f.length)return;let r=f.shift(),t=+e.id,o={messageNo:r.qoper8.messageNo,request:r,callback:r.qoper8.callback};if(h.set(t,o),delete r.qoper8.callback,delete r.qoper8.messageNo,u.set(+t,!1),a){let r=setTimeout(function(){if(h.has(t)){let r=h.get(t),o=r.callback,n=r.request;delete n.qoper8;let i={error:"WebWorker handler timeout exceeded",originalRequest:n};o&&o(i,t),h.delete(t),m.delete(t),b({type:"qoper8_terminate"},e)}},a);m.set(t,r)}b(r,e),O.emit("sentToWorker",{message:r,workerId:t})}(e)):(O.log("no available workers"),c.size<r&&(O.log("starting new worker"),function(){let e;if("undefined"!=typeof Bun){const r=new URL("QOper8Worker.js",import.meta.url).href;e=new Worker(r)}else{let r=O.createUrl(workerCode);r?e=new Worker(r):(e={}).postMessage=function(e){}}e.onmessage=function(r){let t=+e.id,o=r.data,n={...o};if(delete n.qoper8,O.emit("replyReceived",{reply:n,workerId:t}),O.log("response received from Worker: "+t),O.log(JSON.stringify(n,null,2)),o.qoper8)if(o.qoper8.finished){if(h.has(t)){let e=h.get(t),r=e.messageNo;O.emit("QBackupDelete",r);let n=e.callback;n&&n(o,t)}if(u.set(t,!0),O.emit("worker"+t+"Available"),clearTimeout(m.get(t)),o.error&&o.shutdown)return c.delete(t),u.delete(t),h.delete(t),m.delete(t),O.emit("worker"+t+"Terminated"),e.terminate(),void(y||q());h.delete(t),u.set(t,!0),m.delete(t),y||q()}else o.qoper8.shutdown&&(O.log("Master shutting down worker "+t),c.delete(t),u.delete(t),h.delete(t),m.delete(t),O.emit("workerTerminated",t),O.emit("worker"+t+"Terminated"),e.terminate())},e.id=w++,b({qoper8:{init:!0,id:e.id,handlersByMessageType:O.handlersByMessageType,workerInactivityCheckInterval:n,workerInactivityLimit:i,logging:O.logging,onStartupModule:l,onStartupArguments:g}},e),c.set(e.id,e),O.emit("workerStarted",e.id)}()))}function b(e,r){e.qoper8||(e.qoper8={}),e.qoper8.uuid=d,r.postMessage(e)}function v(e){return new Promise(r=>{O.on("worker"+e+"Available",function(){O.off("worker"+e+"Available"),r()})})}function M(e){return new Promise(r=>{O.on("worker"+e+"Terminated",function(){O.off("worker"+e+"Terminated"),r()})})}this.log=function(e){!o&&this.logging&&console.log(Date.now()+": "+e)},this.setPoolSize=function(e){+e>0&&+e<t+1&&(r=+e)},this.setOnStartupModule=function(e){l||(l=(e=e||{}).module,g=e.arguments)},this.getMessageCount=function(){return k},this.on=function(e,r){p.has(e)||p.set(e,r)},this.off=function(e){p.has(e)&&p.delete(e)},this.emit=function(e,r){if(p.has(e)){p.get(e).call(O,r)}},this.getQueueLength=function(){return f.length},this.message=function(e,r){e.qoper8||(e.qoper8={}),e.qoper8.callback=r||!1,function(e){if(y)return void(e.qoper8&&e.qoper8.callback&&e.qoper8.callback({error:"QOper8 has been stopped"}));k++,e.qoper8.messageNo=k,f.push(e);let r={...e};delete r.qoper8,O.emit("QBackupAdd",{id:e.qoper8.messageNo,requestObject:r}),O.emit("addedToQueue",e),q()}(e)},this.stop=async function(){y=!0;for(const[e,r]of c)if(u.get(+e)){O.log("Web Worker "+e+" is being stopped"),b({type:"qoper8_terminate"},r),await M(e),O.log("WebWorker "+e+" has been stopped")}else{O.log("Waiting for WebWorker "+e+" to become available"),await v(e),b({type:"qoper8_terminate"},r),await M(e),O.log("WebWorker "+e+" has been stopped")}O.emit("stop"),O.log("No WebWorkers are running.  QOper8 is no longer handling messages")},this.start=function(){y=!1,O.log("QOper8 is started and will handle messages"),q()},"undefined"!=typeof Bun&&this.logging&&(console.log("========================================================"),console.log("qoper8-ww Build "+this.build+"; "+this.buildDate+" running in process "+process.pid),console.log("Max WebWorker Pool Size: "+r),console.log("========================================================"))}send(e){let r=this;return new Promise(t=>{r.message(e,function(e){t(e)})})}createUrl(e){let r,t;try{r=new Blob([e],{type:"application/javascript"})}catch(t){try{let t=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder);t.append(e),r=t.getBlob("application/javascript")}catch(e){return!1}}try{t=(window.URL||window.webkitURL).createObjectURL(r)}catch(e){t=!1}return t}}export{QOper8};