class QOper8{constructor(e){"string"==typeof(e=e||{})&&(e={workerLoaderUrl:e}),e.workerInactivityCheckInterval&&(e.workerInactivityCheckInterval=1e3*e.workerInactivityCheckInterval),e.workerInactivityLimit&&(e.workerInactivityLimit=6e4*e.workerInactivityLimit),this.name="QOper8",this.build="2.1",this.buildDate="1 August 2022",this.logging=e.logging||!1,this.queue=[],this.workers=new Map,this.isAvailable=new Map,this.callbacks=new Map,this.nextWorkerId=0,this.poolSize=e.poolSize||1,this.worker={loaderUrl:e.workerLoaderUrl||"./js/QOper8Worker.min.js",inactivityCheckInterval:e.workerInactivityCheckInterval||6e4,inactivityLimit:e.workerInactivityLimit||12e5},this.handlersByMessageType=e.handlersByMessageType||new Map,this.listeners=new Map}log(e){this.logging&&console.log(Date.now()+": "+e)}addToQueue(e){this.queue.push(e),this.emit("addedToQueue",e),this.processQueue()}message(e,i){e.qoper8={callback:i||!1},this.addToQueue(e)}send(e){let i=this;return new Promise(t=>{i.message(e,function(e){t(e)})})}getWorker(){for(const[e,i]of this.workers){if(i.id=e,this.isAvailable.get(+i.id))return i;this.log("worker "+e+" is not available")}return!1}sendMessageToWorker(e){if(0===this.queue.length)return;let i=this.queue.shift(),t=e.id;this.callbacks.set(t,i.qoper8.callback),delete i.qoper8,this.isAvailable.set(+t,!1),e.postMessage(i),this.emit("sentToWorker",{message:i,workerId:t})}processQueue(){if(this.log("try processing queue: length "+this.queue.length),0===this.queue.length)return void this.log("Queue empty");let e=this.getWorker();e?(this.log("worker "+e.id+" was available. Sending message to it"),this.sendMessageToWorker(e)):(this.log("no available workers"),this.workers.size<this.poolSize&&(this.log("starting new worker"),this.startWorker()))}startWorker(){let e;try{if(this.worker.loaderUrl.startsWith("http")&&navigator.userAgent.includes("Firefox")){zzz}e=new Worker(this.worker.loaderUrl)}catch(i){try{let i;try{i=new Blob(["importScripts('"+this.worker.loaderUrl+"');"],{type:"application/javascript"})}catch(e){let t=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder);t.append("importScripts('"+this.worker.loaderUrl+"');"),i=t.getBlob("application/javascript")}let t=(window.URL||window.webkitURL).createObjectURL(i);e=new Worker(t)}catch(e){console.log("*** Cannot load worker URL "+this.worker.loaderUrl+" even as blob URL")}}let i=this;e.onmessage=function(t){let r=t.data;if(i.emit("replyReceived",{reply:r,workerId:e.id}),i.log("response received from Worker: "+e.id),i.log(JSON.stringify(r,null,2)),i.callbacks.has(e.id)){let t=i.callbacks.get(e.id);t&&t(r),i.callbacks.delete(e.id)}r.qoper8&&(r.qoper8.finished?(i.isAvailable.set(+e.id,!0),i.processQueue()):r.qoper8.shutdown&&(i.log("Master shutting down worker "+e.id),i.workers.delete(e.id),i.emit("workerTerminated",e.id),e.terminate()))},e.id=this.nextWorkerId++,e.postMessage({qoper8:{init:!0,id:e.id,handlersByMessageType:this.handlersByMessageType,workerInactivityCheckTime:this.worker.inactivityCheckTime,workerInactivityLimit:this.worker.inactivityLimit,logging:this.logging}}),this.workers.set(e.id,e),this.emit("workerStarted",e.id)}on(e,i){this.listeners.has(e)||this.listeners.set(e,i)}off(e){this.listeners.has(e)&&this.listeners.delete(e)}emit(e,i){if(this.listeners.has(e)){this.listeners.get(e).call(this,i)}}}export{QOper8};