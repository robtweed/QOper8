let workerCode='let QWorker=class{constructor(){this.logging=!1;let e=new Map,r=new Map,t=!1,o=!1,i=this,n=!1,a=!1,s=!1,g=6e4,l=18e4,p=new Map,u=!1,c=Date.now(),d=0,y=function(){i.log("Worker "+t+" sending request to shut down");u&&clearInterval(u),postMessage({qoper8:{shutdown:!0}}),i.emit("shutdown_signal_sent")},f=function(e){(e=e||{}).qoper8||(e.qoper8={}),e.qoper8.finished=!0,postMessage(e),i.emit("finished",e),n=!1,a&&y()};this.getMessageCount=function(){return d},this.on=function(r,t){e.has(r)||e.set(r,t)},this.off=function(r){e.has(r)&&e.delete(r)},this.emit=function(r,t){if(e.has(r)){e.get(r).call(this,t)}},this.onMessage=async function(e){let m;if(c=Date.now(),n=!0,e.qoper8&&e.qoper8.init&&void 0!==e.qoper8.id){if(o)return m="QOper8 Worker "+t+" has already been initialised",i.emit("error",m),f({error:m,originalMessage:e});if("undefined"!=typeof Bun&&e.qoper8.onStartupModule){let r;try{let{onStartupModule:o}=await import(e.qoper8.onStartupModule);r=o}catch(r){return m="Unable to load onStartup customisation module "+e.qoper8.onStartupModule,i.log(m),i.log(JSON.stringify(r,Object.getOwnPropertyNames(r))),i.emit("error",{error:m,caughtError:JSON.stringify(r,Object.getOwnPropertyNames(r))}),f({error:m,caughtError:JSON.stringify(r,Object.getOwnPropertyNames(r)),originalMessage:e,workerId:t})}try{r.call(i,e.qoper8.onStartupArguments)}catch(r){return m="Error running onStartup customisation module "+e.qoper8.onStartupModule,i.log(m),i.log(JSON.stringify(r,Object.getOwnPropertyNames(r))),i.emit("error",{error:m,caughtError:JSON.stringify(r,Object.getOwnPropertyNames(r))}),f({error:m,caughtError:JSON.stringify(r,Object.getOwnPropertyNames(r)),originalMessage:e,workerId:t})}}return t=e.qoper8.id,s=e.qoper8.uuid,e.qoper8.workerInactivityCheckInterval&&(g=e.qoper8.workerInactivityCheckInterval),e.qoper8.workerInactivityLimit&&(l=e.qoper8.workerInactivityLimit),e.qoper8.handlersByMessageType&&(p=e.qoper8.handlersByMessageType),i.logging=e.qoper8.logging,u=setInterval(function(){let e=Date.now()-c;i.log("Worker "+t+" inactive for "+e),i.log("Inactivity limit: "+l),e>l&&(n?(i.log("Worker "+t+" flagged for termination"),a=!0):y())},g),i.log("new worker "+t+" started..."),i.emit("started",{id:t}),o=!0,f()}if(!o)return m="QOper8 Worker "+t+" has not been initialised",i.emit("error",m),f({error:m,originalMessage:e});if(!e.qoper8||!e.qoper8.uuid)return m="Invalid message sent to QOper8 Worker "+t,i.emit("error",m),f({error:m,originalMessage:e});if(e.qoper8.uuid!==s)return m="Invalid UUID on message sent to QOper8 Worker "+t,i.emit("error",m),f({error:m,originalMessage:e});let h={...e};if(delete e.qoper8.uuid,delete h.qoper8,i.log("Message received by worker "+t+": "+JSON.stringify(h,null,2)),i.emit("received",{message:h}),"qoper8_terminate"!==e.type){if(!e.type&&!e.handlerUrl)return m="No type or handler specified in message sent to worker "+t,i.emit("error",m),f({error:m,originalMessage:h});if(!e.type||!p.has(e.type))return m="No handler for messages of type "+e.type,i.log(m),i.emit("error",m),f({error:m,originalMessage:h});{if(!r.has(e.type)){let o=p.get(e.type);o.module&&(o=o.module),i.log("fetching "+o);try{let n;if("undefined"!=typeof Bun){let{handler:e}=await import(o);n=e}else importScripts(o),n=self.handler;r.set(e.type,n),i.emit("handler_imported",{handlerUrl:o})}catch(e){return m="Unable to load Handler Url "+o,i.log(m),i.log(JSON.stringify(e,Object.getOwnPropertyNames(e))),i.emit("error",{error:m,caughtError:JSON.stringify(e,Object.getOwnPropertyNames(e))}),f({error:m,caughtError:JSON.stringify(e,Object.getOwnPropertyNames(e)),originalMessage:h,workerId:t})}}d++;let o=r.get(e.type);try{let r={...i};r.id=t,o.call(r,e,f)}catch(r){return m="Error running Handler Method for type "+e.type,i.log(m),i.log(JSON.stringify(r,Object.getOwnPropertyNames(r))),i.emit("error",{error:m,caughtError:JSON.stringify(r,Object.getOwnPropertyNames(r))}),u&&clearInterval(u),f({error:m,caughtError:JSON.stringify(r,Object.getOwnPropertyNames(r)),shutdown:!0,originalMessage:h,workerId:t})}}}else y()}}log(e){this.logging&&console.log(Date.now()+": "+e)}},QOper8Worker=new QWorker;onmessage=async function(e){QOper8Worker.onMessage(e.data)};';class QOper8{constructor(e){(e=e||{}).workerInactivityCheckInterval&&(e.workerInactivityCheckInterval=1e3*e.workerInactivityCheckInterval),e.workerInactivityLimit&&(e.workerInactivityLimit=6e4*e.workerInactivityLimit),this.name="QOper8",this.build="3.0",this.buildDate="7 September 2023",this.logging=e.logging||!1;let r=+e.poolSize||1,t=e.maxPoolSize||32;r>t&&(r=t);let o=e.disabled||!1,i=e.workerInactivityCheckInterval||6e4,n=e.workerInactivityLimit||12e5;this.handlersByMessageType=e.handlersByMessageType||new Map;let a=e.handlerTimeout||!1,s=e.onStartup||{},l=s.module,g=s.arguments,p=new Map,u="undefined"!=typeof window&&"https:"===window.location.protocol?([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)):"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){let r=16*Math.random()|0;return("x"==e?r:3&r|8).toString(16)}),d=new Map,c=new Map,m=new Map,f=new Map,h=[],w=0,y=!1,k=0,q=this;function b(){if(q.log("try processing queue: length "+h.length),0===h.length)return void q.log("Queue empty");let e=function(){for(const[e,r]of d){if(r.id=e,c.get(+r.id))return r;q.log("worker "+e+" is not available")}return!1}();e?(q.log("worker "+e.id+" was available. Sending message to it"),function(e){if(0===h.length)return;let r=h.shift(),t=+e.id,o={messageNo:r.qoper8.messageNo,request:r,callback:r.qoper8.callback};if(m.set(t,o),delete r.qoper8.callback,delete r.qoper8.messageNo,c.set(+t,!1),a){let r=setTimeout(function(){if(m.has(t)){let r=m.get(t),o=r.callback,i=r.request;delete i.qoper8;let n={error:"WebWorker handler timeout exceeded",originalRequest:i};o&&o(n,t),m.delete(t),f.delete(t),O({type:"qoper8_terminate"},e)}},a);f.set(t,r)}O(r,e),q.emit("sentToWorker",{message:r,workerId:t})}(e)):(q.log("no available workers"),d.size<r&&(q.log("starting new worker"),function(){let e;if("undefined"!=typeof Bun){const r=new URL("QOper8Worker.js",import.meta.url).href;e=new Worker(r)}else{let e,r=q.createUrl(workerCode);r?e=new Worker(r):(e={}).postMessage=function(e){}}e.onmessage=function(r){let t=+e.id,o=r.data,i={...o};if(delete i.qoper8,q.emit("replyReceived",{reply:i,workerId:t}),q.log("response received from Worker: "+t),q.log(JSON.stringify(i,null,2)),o.qoper8)if(o.qoper8.finished){if(m.has(t)){let e=m.get(t),r=e.messageNo;q.emit("QBackupDelete",r);let i=e.callback;i&&i(o,t)}if(c.set(t,!0),q.emit("worker"+t+"Available"),clearTimeout(f.get(t)),o.error&&o.shutdown)return d.delete(t),c.delete(t),m.delete(t),f.delete(t),q.emit("worker"+t+"Terminated"),e.terminate(),void(y||b());m.delete(t),c.set(t,!0),f.delete(t),y||b()}else o.qoper8.shutdown&&(q.log("Master shutting down worker "+t),d.delete(t),c.delete(t),m.delete(t),f.delete(t),q.emit("workerTerminated",t),q.emit("worker"+t+"Terminated"),e.terminate())},e.id=w++,O({qoper8:{init:!0,id:e.id,handlersByMessageType:q.handlersByMessageType,workerInactivityCheckInterval:i,workerInactivityLimit:n,logging:q.logging,onStartupModule:l,onStartupArguments:g}},e),d.set(e.id,e),q.emit("workerStarted",e.id)}()))}function O(e,r){e.qoper8||(e.qoper8={}),e.qoper8.uuid=u,r.postMessage(e)}function v(e){return new Promise(r=>{q.on("worker"+e+"Available",function(){q.off("worker"+e+"Available"),r()})})}function M(e){return new Promise(r=>{q.on("worker"+e+"Terminated",function(){q.off("worker"+e+"Terminated"),r()})})}this.log=function(e){!o&&this.logging&&console.log(Date.now()+": "+e)},this.setPoolSize=function(e){+e>0&&+e<t+1&&(r=+e)},this.setOnStartupModule=function(e){l||(l=(e=e||{}).module,g=e.arguments)},this.getMessageCount=function(){return k},this.on=function(e,r){p.has(e)||p.set(e,r)},this.off=function(e){p.has(e)&&p.delete(e)},this.emit=function(e,r){if(p.has(e)){p.get(e).call(q,r)}},this.getQueueLength=function(){return h.length},this.message=function(e,r){e.qoper8||(e.qoper8={}),e.qoper8.callback=r||!1,function(e){if(y)return void(e.qoper8&&e.qoper8.callback&&e.qoper8.callback({error:"QOper8 has been stopped"}));k++,e.qoper8.messageNo=k,h.push(e);let r={...e};delete r.qoper8,q.emit("QBackupAdd",{id:e.qoper8.messageNo,requestObject:r}),q.emit("addedToQueue",e),b()}(e)},this.stop=async function(){y=!0;for(const[e,r]of d)if(c.get(+e)){q.log("Web Worker "+e+" is being stopped"),O({type:"qoper8_terminate"},r),await M(e),q.log("WebWorker "+e+" has been stopped")}else{q.log("Waiting for WebWorker "+e+" to become available"),await v(e),O({type:"qoper8_terminate"},r),await M(e),q.log("WebWorker "+e+" has been stopped")}q.emit("stop"),q.log("No WebWorkers are running.  QOper8 is no longer handling messages")},this.start=function(){y=!1,q.log("QOper8 is started and will handle messages"),b()}}send(e){let r=this;return new Promise(t=>{r.message(e,function(e){t(e)})})}createUrl(e){let r,t;try{r=new Blob([e],{type:"application/javascript"})}catch(t){try{let t=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder);t.append(e),r=t.getBlob("application/javascript")}catch(e){return!1}}try{t=(window.URL||window.webkitURL).createObjectURL(r)}catch(e){t=!1}return t}}export{QOper8};