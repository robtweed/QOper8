let workerCode='let QWorker=class{constructor(){this.logging=!1;let e=new Map,r=new Map,t=!1,o=!1,i=this,n=!1,s=!1,a=!1,g=6e4,l=18e4,p=new Map,d=!1,c=Date.now(),h=0,y=function(){i.log("Worker "+t+" sending request to shut down");d&&clearInterval(d),postMessage({qoper8:{shutdown:!0}}),i.emit("shutdown_signal_sent")},u=function(e){(e=e||{}).qoper8||(e.qoper8={}),e.qoper8.finished=!0,postMessage(e),i.emit("finished",e),n=!1,s&&y()};this.getMessageCount=function(){return h},this.on=function(r,t){e.has(r)||e.set(r,t)},this.off=function(r){e.has(r)&&e.delete(r)},this.emit=function(r,t){if(e.has(r)){e.get(r).call(this,t)}},this.onMessage=function(e){let f;if(c=Date.now(),n=!0,e.qoper8&&e.qoper8.init&&void 0!==e.qoper8.id)return o?(f="QOper8 Worker "+t+" has already been initialised",i.emit("error",f),u({error:f,originalMessage:e})):(t=e.qoper8.id,a=e.qoper8.uuid,e.qoper8.workerInactivityCheckInterval&&(g=e.qoper8.workerInactivityCheckInterval),e.qoper8.workerInactivityLimit&&(l=e.qoper8.workerInactivityLimit),e.qoper8.handlersByMessageType&&(p=e.qoper8.handlersByMessageType),i.logging=e.qoper8.logging,d=setInterval(function(){let e=Date.now()-c;i.log("Worker "+t+" inactive for "+e),i.log("Inactivity limit: "+l),e>l&&(n?(i.log("Worker "+t+" flagged for termination"),s=!0):y())},g),i.log("new worker "+t+" started..."),i.emit("started",{id:t}),o=!0,u());if(!o)return f="QOper8 Worker "+t+" has not been initialised",i.emit("error",f),u({error:f,originalMessage:e});if(!e.qoper8||!e.qoper8.uuid)return f="Invalid message sent to QOper8 Worker "+t,i.emit("error",f),u({error:f,originalMessage:e});if(e.qoper8.uuid!==a)return f="Invalid UUID on message sent to QOper8 Worker "+t,i.emit("error",f),u({error:f,originalMessage:e});let m={...e};if(delete e.qoper8.uuid,delete m.qoper8,i.log("Message received by worker "+t+": "+JSON.stringify(m,null,2)),i.emit("received",{message:m}),"qoper8_terminate"!==e.type){if(!e.type&&!e.handlerUrl)return f="No type or handler specified in message sent to worker "+t,i.emit("error",f),u({error:f,originalMessage:m});if(!e.type||!p.has(e.type))return f="No handler for messages of type "+e.type,i.log(f),i.emit("error",f),u({error:f,originalMessage:m});{if(!r.has(e.type)){let o=p.get(e.type);i.log("fetching "+o);try{importScripts(o);let n=self.handler;r.set(e.type,n),i.emit("handler_imported",{handlerUrl:o})}catch(e){return f="Unable to load Handler Url "+o,i.log(f),i.log(JSON.stringify(e,Object.getOwnPropertyNames(e))),i.emit("error",{error:f,caughtError:JSON.stringify(e,Object.getOwnPropertyNames(e))}),u({error:f,caughtError:JSON.stringify(e,Object.getOwnPropertyNames(e)),originalMessage:m,workerId:t})}}h++;let o=r.get(e.type);try{let r={...i};r.id=t,o.call(r,e,u)}catch(r){return f="Error running Handler Method for type "+e.type,i.log(f),i.log(JSON.stringify(r,Object.getOwnPropertyNames(r))),i.emit("error",{error:f,caughtError:JSON.stringify(r,Object.getOwnPropertyNames(r))}),d&&clearInterval(d),u({error:f,caughtError:JSON.stringify(r,Object.getOwnPropertyNames(r)),shutdown:!0,originalMessage:m,workerId:t})}}}else y()}}log(e){this.logging&&console.log(Date.now()+": "+e)}},QOper8Worker=new QWorker;onmessage=async function(e){QOper8Worker.onMessage(e.data)};';class QOper8{constructor(e){(e=e||{}).workerInactivityCheckInterval&&(e.workerInactivityCheckInterval=1e3*e.workerInactivityCheckInterval),e.workerInactivityLimit&&(e.workerInactivityLimit=6e4*e.workerInactivityLimit),this.name="QOper8",this.build="2.6",this.buildDate="23 August 2022",this.logging=e.logging||!1;let r=+e.poolSize||1,t=e.maxPoolSize||32;r>t&&(r=t);let o=e.disabled||!1,i=e.workerInactivityCheckInterval||6e4,n=e.workerInactivityLimit||12e5;this.handlersByMessageType=e.handlersByMessageType||new Map;let a=e.handlerTimeout||!1,s=new Map,l="https:"===window.location.protocol?([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)):"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){let r=16*Math.random()|0;return("x"==e?r:3&r|8).toString(16)}),g=new Map,p=new Map,d=new Map,c=new Map,u=[],f=0,h=!1,m=0,w=this;function y(){if(w.log("try processing queue: length "+u.length),0===u.length)return void w.log("Queue empty");let e=function(){for(const[e,r]of g){if(r.id=e,p.get(+r.id))return r;w.log("worker "+e+" is not available")}return!1}();e?(w.log("worker "+e.id+" was available. Sending message to it"),function(e){if(0===u.length)return;let r=u.shift(),t=+e.id,o={messageNo:r.qoper8.messageNo,request:r,callback:r.qoper8.callback};if(d.set(t,o),delete r.qoper8.callback,delete r.qoper8.messageNo,p.set(+t,!1),a){let r=setTimeout(function(){if(d.has(t)){let r=d.get(t),o=r.callback,i=r.request;delete i.qoper8;let n={error:"WebWorker handler timeout exceeded",originalRequest:i};o&&o(n,t),d.delete(t),c.delete(t),k({type:"qoper8_terminate"},e)}},a);c.set(t,r)}k(r,e),w.emit("sentToWorker",{message:r,workerId:t})}(e)):(w.log("no available workers"),g.size<r&&(w.log("starting new worker"),function(){let e,r=w.createUrl(workerCode);r?e=new Worker(r):(e={}).postMessage=function(e){};e.onmessage=function(r){let t=+e.id,o=r.data,i={...o};if(delete i.qoper8,w.emit("replyReceived",{reply:i,workerId:t}),w.log("response received from Worker: "+t),w.log(JSON.stringify(i,null,2)),o.qoper8)if(o.qoper8.finished){if(d.has(t)){let e=d.get(t),r=e.messageNo;w.emit("QBackupDelete",r);let i=e.callback;i&&i(o,t)}if(p.set(t,!0),w.emit("worker"+t+"Available"),clearTimeout(c.get(t)),o.error&&o.shutdown)return g.delete(t),p.delete(t),d.delete(t),c.delete(t),w.emit("worker"+t+"Terminated"),e.terminate(),void(h||y());d.delete(t),p.set(t,!0),c.delete(t),h||y()}else o.qoper8.shutdown&&(w.log("Master shutting down worker "+t),g.delete(t),p.delete(t),d.delete(t),c.delete(t),w.emit("workerTerminated",t),w.emit("worker"+t+"Terminated"),e.terminate())},e.id=f++,k({qoper8:{init:!0,id:e.id,handlersByMessageType:w.handlersByMessageType,workerInactivityCheckInterval:i,workerInactivityLimit:n,logging:w.logging}},e),g.set(e.id,e),w.emit("workerStarted",e.id)}()))}function k(e,r){e.qoper8||(e.qoper8={}),e.qoper8.uuid=l,r.postMessage(e)}function q(e){return new Promise(r=>{w.on("worker"+e+"Available",function(){w.off("worker"+e+"Available"),r()})})}function b(e){return new Promise(r=>{w.on("worker"+e+"Terminated",function(){w.off("worker"+e+"Terminated"),r()})})}this.log=function(e){!o&&this.logging&&console.log(Date.now()+": "+e)},this.getMessageCount=function(){return m},this.on=function(e,r){s.has(e)||s.set(e,r)},this.off=function(e){s.has(e)&&s.delete(e)},this.emit=function(e,r){if(s.has(e)){s.get(e).call(w,r)}},this.getQueueLength=function(){return u.length},this.message=function(e,r){e.qoper8||(e.qoper8={}),e.qoper8.callback=r||!1,function(e){if(h)return void(e.qoper8&&e.qoper8.callback&&e.qoper8.callback({error:"QOper8 has been stopped"}));m++,e.qoper8.messageNo=m,u.push(e);let r={...e};delete r.qoper8,w.emit("QBackupAdd",{id:e.qoper8.messageNo,requestObject:r}),w.emit("addedToQueue",e),y()}(e)},this.stop=async function(){h=!0;for(const[e,r]of g)if(p.get(+e)){w.log("Web Worker "+e+" is being stopped"),k({type:"qoper8_terminate"},r),await b(e),w.log("WebWorker "+e+" has been stopped")}else{w.log("Waiting for WebWorker "+e+" to become available"),await q(e),k({type:"qoper8_terminate"},r),await b(e),w.log("WebWorker "+e+" has been stopped")}w.emit("stop"),w.log("No WebWorkers are running.  QOper8 is no longer handling messages")},this.start=function(){h=!1,w.log("QOper8 is started and will handle messages"),y()}}send(e){let r=this;return new Promise(t=>{r.message(e,function(e){t(e)})})}createUrl(e){let r,t;try{r=new Blob([e],{type:"application/javascript"})}catch(t){try{let t=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder);t.append(e),r=t.getBlob("application/javascript")}catch(e){return!1}}try{t=(window.URL||window.webkitURL).createObjectURL(r)}catch(e){t=!1}return t}}export{QOper8};