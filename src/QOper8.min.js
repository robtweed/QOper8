let workerCode='let QWorker=class{constructor(){this.logging=!1;let e=new Map,r=new Map,t=!1,o=!1,i=this,n=!1,s=!1,a=!1,l=6e4,g=18e4,p=new Map,d=!1,f=Date.now(),h=0,u=function(){i.log("Worker "+t+" sending request to shut down");clearInterval(QOper8Worker.timer),postMessage({qoper8:{shutdown:!0}}),i.emit("shutdown_signal_sent")},c=function(e){(e=e||{}).qoper8||(e.qoper8={}),e.qoper8.finished=!0,postMessage(e),i.emit("finished",e),n=!1,s&&u()};this.getMessageCount=function(){return h},this.on=function(r,t){e.has(r)||e.set(r,t)},this.off=function(r){e.has(r)&&e.delete(r)},this.emit=function(r,t){if(e.has(r)){e.get(r).call(this,t)}},this.onMessage=function(e){let m;if(f=Date.now(),n=!0,e.qoper8&&e.qoper8.init&&void 0!==e.qoper8.id)return o?(m="QOper8 Worker "+t+" has already been initialised",i.emit("error",m),c({error:m,originalMessage:e})):(t=e.qoper8.id,a=e.qoper8.uuid,e.qoper8.workerInactivityCheckInterval&&(l=e.qoper8.workerInactivityCheckInterval),e.qoper8.workerInactivityLimit&&(g=e.qoper8.workerInactivityLimit),e.qoper8.handlersByMessageType&&(p=e.qoper8.handlersByMessageType),i.logging=e.qoper8.logging,d=setInterval(function(){let e=Date.now()-f;i.log("Worker "+t+" inactive for "+e),i.log("Inactivity limit: "+g),e>g&&(n?(i.log("Worker "+t+" flagged for termination"),s=!0):u())},l),i.log("new worker "+t+" started..."),i.emit("started",{id:t}),o=!0,c());if(!o)return m="QOper8 Worker "+t+" has not been initialised",i.emit("error",m),c({error:m,originalMessage:e});if(!e.qoper8||!e.qoper8.uuid)return m="Invalid message sent to QOper8 Worker "+t,i.emit("error",m),c({error:m,originalMessage:e});if(e.qoper8.uuid!==a)return m="Invalid UUID on message sent to QOper8 Worker "+t,i.emit("error",m),c({error:m,originalMessage:e});let y=JSON.parse(JSON.stringify(e));if(delete e.qoper8.uuid,delete y.qoper8,i.log("Message received by worker "+t+": "+JSON.stringify(y,null,2)),i.emit("received",{message:y}),"qoper8_terminate"!==e.type){if(!e.type&&!e.handlerUrl)return m="No type or handler specified in message sent to worker "+t,i.emit("error",m),c({error:m,originalMessage:y});if(!e.type||!p.has(e.type))return m="No handler for messages of type "+e.type,i.log(m),i.emit("error",m),c({error:m,originalMessage:y});if(!r.has(e.type)){let o=p.get(e.type);i.log("fetching "+o);try{importScripts(o);let n=self.handler;r.set(e.type,n),i.emit("handler_imported",{handlerUrl:o})}catch(e){return m="Unable to load Handler Url "+o,i.log(m),i.log(JSON.stringify(e,null,2)),i.emit("error",m),c({error:m,originalMessage:y,workerId:t})}}h++,r.get(e.type).call(i,e,c)}else u()}}log(e){this.logging&&console.log(Date.now()+": "+e)}},QOper8Worker=new QWorker;onmessage=async function(e){QOper8Worker.onMessage(e.data)};';class QOper8{constructor(e){(e=e||{}).workerInactivityCheckInterval&&(e.workerInactivityCheckInterval=1e3*e.workerInactivityCheckInterval),e.workerInactivityLimit&&(e.workerInactivityLimit=6e4*e.workerInactivityLimit),this.name="QOper8",this.build="2.5",this.buildDate="15 August 2022",this.logging=e.logging||!1;let r=+e.poolSize||1,t=e.maxPoolSize||32;r>t&&(r=t);let i=e.disabled||!1,o=e.workerInactivityCheckInterval||6e4,n=e.workerInactivityLimit||12e5;this.handlersByMessageType=e.handlersByMessageType||new Map;let a=new Map,s="https:"===window.location.protocol?([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)):"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){let r=16*Math.random()|0;return("x"==e?r:3&r|8).toString(16)}),l=new Map,g=new Map,p=new Map,d=[],c=0,u=!1,h=0,m=this;function f(){if(m.log("try processing queue: length "+d.length),0===d.length)return void m.log("Queue empty");let e=function(){for(const[e,r]of l){if(r.id=e,g.get(+r.id))return r;m.log("worker "+e+" is not available")}return!1}();e?(m.log("worker "+e.id+" was available. Sending message to it"),function(e){if(0===d.length)return;let r=d.shift(),t=e.id;p.set(t,r.qoper8.callback),delete r.qoper8.callback,g.set(+t,!1),w(r,e),m.emit("sentToWorker",{message:r,workerId:t})}(e)):(m.log("no available workers"),l.size<r&&(m.log("starting new worker"),function(){let e,r=m.createUrl(workerCode);r?e=new Worker(r):(e={}).postMessage=function(e){};e.onmessage=function(r){let t=r.data,i=JSON.parse(JSON.stringify(t));if(delete i.qoper8,m.emit("replyReceived",{reply:i,workerId:e.id}),m.log("response received from Worker: "+e.id),m.log(JSON.stringify(i,null,2)),p.has(e.id)){let r=p.get(e.id);r&&r(t,e.id),p.delete(e.id)}t.qoper8&&(t.qoper8.finished?(g.set(+e.id,!0),m.emit("worker"+e.id+"Available"),u||f()):t.qoper8.shutdown&&(m.log("Master shutting down worker "+e.id),l.delete(e.id),m.emit("workerTerminated",e.id),m.emit("worker"+e.id+"Terminated"),e.terminate()))},e.id=c++,w({qoper8:{init:!0,id:e.id,handlersByMessageType:m.handlersByMessageType,workerInactivityCheckInterval:o,workerInactivityLimit:n,logging:m.logging}},e),l.set(e.id,e),m.emit("workerStarted",e.id)}()))}function w(e,r){e.qoper8||(e.qoper8={}),e.qoper8.uuid=s,r.postMessage(e)}function y(e){return new Promise(r=>{m.on("worker"+e+"Available",function(){m.off("worker"+e+"Available"),r()})})}function k(e){return new Promise(r=>{m.on("worker"+e+"Terminated",function(){m.off("worker"+e+"Terminated"),r()})})}this.log=function(e){!i&&this.logging&&console.log(Date.now()+": "+e)},this.getMessageCount=function(){return h},this.on=function(e,r){a.has(e)||a.set(e,r)},this.off=function(e){a.has(e)&&a.delete(e)},this.emit=function(e,r){if(a.has(e)){a.get(e).call(m,r)}},this.getQueueLength=function(){return d.length},this.message=function(e,r){e.qoper8||(e.qoper8={}),e.qoper8.callback=r||!1,function(e){u?e.qoper8&&e.qoper8.callback&&e.qoper8.callback({error:"QOper8 has been stopped"}):(h++,d.push(e),m.emit("addedToQueue",e),f())}(e)},this.stop=async function(){u=!0;for(const[e,r]of l)if(g.get(+e)){m.log("Web Worker "+e+" is being stopped"),w({type:"qoper8_terminate"},r),await k(e),m.log("Worker Thread "+e+" has been stopped")}else{m.log("Waiting for Worker Thread "+e+" to become available"),await y(e),w({type:"qoper8_terminate"},r),await k(e),m.log("Worker Thread "+e+" has been stopped")}m.emit("stop"),m.log("No Worker Threads are running.  QOper8 is no longer handling messages")},this.start=function(){u=!1,m.log("QOper8 is started and will handle messages"),f()}}send(e){let r=this;return new Promise(t=>{r.message(e,function(e){t(e)})})}createUrl(e){let r,t;try{r=new Blob([e],{type:"application/javascript"})}catch(t){try{let t=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder);t.append(e),r=t.getBlob("application/javascript")}catch(e){return!1}}try{t=(window.URL||window.webkitURL).createObjectURL(r)}catch(e){t=!1}return t}}export{QOper8};